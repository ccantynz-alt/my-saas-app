name: D8 Prod Watchdog (heartbeat)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *"

permissions:
  issues: write
  contents: read

concurrency:
  group: d8-watchdog
  cancel-in-progress: true

jobs:
  check:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Check heartbeat (expect 200)
        id: check
        run: |
          set -e
          TS=$(date +%s)
          URL="https://www.dominat8.com/api/__health__?ts=$TS"

          H=$(curl -s -D - --max-time 20 -H "cache-control: no-cache" -H "pragma: no-cache" "$URL" -o /dev/null)
          CODE=$(echo "$H" | awk 'tolower($0) ~ /^http\// {print $2; exit}')

          printf "### %s\n\n```\n%s\n```\nDetectedStatus: %s\n" "$URL" "$H" "$CODE" > report.md

          if [ "$CODE" = "200" ]; then
            echo "fail=0" >> $GITHUB_OUTPUT
          else
            echo "fail=1" >> $GITHUB_OUTPUT
          fi

      - name: Open Issue if failing
        if: steps.check.outputs.fail == '1'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          TITLE="D8 WATCHDOG: Heartbeat not 200 ($(date -u +'%Y-%m-%dT%H:%MZ'))"
          BODY="$(cat report.md)"
          gh issue create --title "$TITLE" --body "$BODY" || true
